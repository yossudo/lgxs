# TNETタスク仕様書

## はじめに
本仕様書は、LGX-Shieldシステムにおけるネットワーク送信タスク（TNET）のソフトウェア仕様を示すものである。  
TNETはアプリケーションタスク（TAPP）からの要求を受け、UDPパケットを生成してLAN内のサーバへ送信する役割を担う。

---

## 機能概要
TNETは以下の機能を提供する。

1. **AI判定結果の受領**  
   TAPPから送信されるAI判定結果を受信する。

2. **UDPパケット生成と送信**  
   AI判定結果をペイロードに含めたUDPパケットを生成し、Ethernetドライバ経由で送信する。

3. **結果通知**  
   UDP送信後、送信内容をTAPPへ通知する。応答は片方向通信であり、サーバからの返信は想定しない。

4. **デバイス初期化**  
   低レベルEtherドライバ（T-Kernelデバイス "hetha"）をオープンし、通信に備える。

---

## 機能詳細

### 1. タスク初期化
- **関数名**: `init_task_tnet`  
- **処理内容**:  
  - Ethernetデバイス "hetha" をオープンする。  
  - すでにオープン済みであれば再利用する。  
  - オープン結果をログ出力する。

---

### 2. タスクメイン
- **関数名**: `task_tnet`  
- **処理内容**:  
  1. 初期化処理を呼び出しEthernetデバイスを準備。  
  2. 無限ループ内でメールボックス `MBXID_TNET` からメッセージを受信。  
  3. 受信メッセージが `MSGID_TNET_REQ` の場合、AI判定結果をUDPパケットとして送信する。  
  4. 送信完了後、`MSGID_TNET_RES` を生成してTAPPへ通知する。  
  5. メモリを解放し、次の処理へ進む。  

---

### 3. UDP送信処理
- **関数名**: `send_udp_packet`  
- **処理内容**:  
  - Ethernet/IP/UDPヘッダを生成。  
  - ペイロード部にAI判定結果を文字列として格納（例: `"LGXS AI=1\n"`）。  
  - チェックサムを計算（IPヘッダのみ、UDPチェックサムは0固定）。  
  - `tk_swri_dev` を用いてEthernetデバイスに書き込み、LAN上に送信。  

---

### 4. 応答通知処理
- **関数名**: `send_net_res`  
- **処理内容**:  
  - 固定長メモリプール `MPFID_SMALL` から領域を確保。  
  - `MSGID_TNET_RES` メッセージを作成し、TAPPへ送信。  
  - 結果値としてAI判定結果を格納する。  

---

## その他
1. **片方向通信モデル**  
   UDP送信のみを対象とし、サーバからの応答は待たない設計とする。これによりシンプルかつリアルタイム性を優先した処理を実現している。  

2. **拡張性**  
   送信ペイロードは現在AI判定結果のみであるが、センサデータや解析情報を追加することで将来的な拡張に対応可能である。  

3. **役割**  
   TNETはシステムにおける「外部通知インタフェース」として、解析結果をネットワーク越しに伝達する機能を担い、遠隔監視を可能とする。  
