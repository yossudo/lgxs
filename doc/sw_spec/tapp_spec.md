# TAPPタスク仕様書

## はじめに
本仕様書は、LGX-Shieldシステムにおけるアプリケーションタスク（TAPP）のソフトウェア仕様を示すものである。  
TAPPはシステム全体の中核となる制御タスクとして、センサデータの収集結果を処理し、AIによる推論、ネットワーク通知へとつなげる役割を担う。

---

## 機能概要
TAPPは以下の機能を提供する。

1. **センサデータ受領とAI推論要求**  
   TIMUタスクから加速度データを受領し、AIタスクへ推論要求を送信する。

2. **AI推論結果の受領と送信要求**  
   AIタスクから推論結果を受領し、ネットワーク送信用のTNETタスクへ送信要求を発行する。

3. **ネットワーク送信結果の受領**  
   TNETタスクからの送信結果を受領し、処理の完了を確認する。

4. **メッセージ駆動型処理**  
   メールボックスを介した非同期メッセージ通信により、各タスク間の独立性とリアルタイム性を確保する。

---

## 機能詳細

### 1. タスク初期化
- **関数名**: `init_task_tapp`  
- **処理内容**: TAPPタスクの初期化処理を行う。現状では特別な処理は実装されていないが、将来的な拡張に対応可能な構造とする。

---

### 2. メインループ
- **関数名**: `task_tapp`  
- **処理内容**:  
  - メールボックス `MBXID_TAPP` でメッセージを受信する。  
  - 受信したメッセージ種別に応じて以下の処理を行う。  

| メッセージID | 送信元 | 処理内容 |
|--------------|--------|----------|
| `MSGID_TIMU_IND` | TIMUタスク | 加速度データを受領し、AI推論要求を発行 |
| `MSGID_TAI_RES`  | TAIタスク  | AI推論結果を受領し、ネットワーク送信要求を発行 |
| `MSGID_TNET_RES` | TNETタスク | ネットワーク送信完了を受領し、処理を終了 |

- **設計上の特徴**: 受信メッセージ単位で処理が完結し、異常時はエラーログを出力した上でメインループを継続する。

---

### 3. AI推論要求送信
- **関数名**: `send_ai_req`  
- **処理内容**:  
  - 固定長メモリプール `MPFID_LARGE` から領域を確保する。  
  - `MSGID_TAI_REQ` メッセージを作成し、AIタスクへ送信する。  

- **引数**:  
  - `result`: センサデータ取得結果（成否）  
  - `data`: センサデータ構造体  

---

### 4. ネットワーク送信要求
- **関数名**: `send_net_req`  
- **処理内容**:  
  - 固定長メモリプール `MPFID_LARGE` から領域を確保する。  
  - `MSGID_TNET_REQ` メッセージを作成し、TNETタスクへ送信する。  

- **引数**:  
  - `result`: AI判定結果  
  - `data`: ネットワーク送信用データ（拡張用）

---

## その他
1. **拡張性**  
   TAPPはメッセージ駆動設計を採用しており、ログ保存機能やクラウド応答処理などの拡張が容易である。  

2. **リアルタイム性**  
   センサデータ取得、AI推論、ネットワーク通信を分離し、処理を非同期で連携させることで、タスクごとのリアルタイム性を維持している。  
