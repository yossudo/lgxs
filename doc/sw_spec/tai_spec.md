# TAIタスク仕様書

## はじめに
本仕様書は、LGX-ShieldシステムにおけるAI推論タスク（TAI）のソフトウェア仕様を示すものである。  
TAIは加速度センサから得られたサンプルデータに対して信号処理および推論処理を行い、異常傾向を検出してアプリケーションタスク（TAPP）へ通知する役割を担う。

---

## 機能概要
TAIは以下の機能を提供する。

1. **センサデータ受領**  
   TAPPから通知される加速度Z軸データ（1024サンプル）を受信する。

2. **FFTによる周波数解析**  
   CMSIS-DSPライブラリを用いて高速フーリエ変換（FFT）を実施し、振動の主要成分を抽出する。

3. **異常判定**  
   最大周波数成分を算出し、閾値（20Hz）を基準に簡易的な異常判定を行う。  
   判定結果は将来的にニューラルネットワーク推論に置き換え可能。

4. **結果通知**  
   判定結果をTAPPへ送信する。

---

## 機能詳細

### 1. タスク初期化
- **関数名**: `init_task_tai`  
- **処理内容**: 初期化処理。現状は空の実装だが、AI推論モデルや内部バッファ初期化の拡張余地を持つ。

---

### 2. タスクメイン
- **関数名**: `task_tai`  
- **処理内容**:  
  1. メールボックス `MBXID_TAI` からメッセージを受信する。  
  2. メッセージ中の加速度Z軸データを取り出し、FFTおよび推論処理を実行する。  
  3. 推論結果をTAPPへ通知する。  
- **特徴**: メッセージ駆動型で動作し、受信ごとにFFT解析と異常判定を実施する。

---

### 3. 信号処理および推論
- **関数名**: `run_fft_and_infer`  
- **処理内容**:  
  1. CMSIS-DSPライブラリを用いてRFFT（実数FFT）を初期化。  
  2. 入力データをfloat型に変換し、平均値を除去（DCオフセット補正）。  
  3. FFTを実行し、複素数結果を振幅スペクトルへ変換。  
  4. 最大振幅成分を探索し、その周波数を算出。  
  5. 周波数閾値と比較して異常判定を実施。  

---

### 4. 判定結果送信
- **関数名**: `send_ai_res`  
- **処理内容**:  
  - 固定長メモリプール `MPFID_SMALL` からメッセージ領域を確保。  
  - 判定結果を `MSGID_TAI_RES` としてTAPPに送信する。  

---

## その他
1. **リアルタイム性**  
   FFTサイズは1024サンプル、サンプリング周期は100Hzであり、約10.24秒ごとの周波数解析を行う。リアルタイムに近い形で異常傾向の検出が可能である。  

2. **拡張性**  
   現在は閾値による簡易判定ロジックを実装しているが、CMSIS-NNを利用した軽量ニューラルネットワーク推論への置換が可能であり、拡張性を備えている。  

3. **役割**  
   TAIはシステムにおける「解析・判定エンジン」として、物理センサデータを解析し、異常の有無を上位タスクへ伝達する重要なタスクである。  
