# TIMUタスク仕様書

## はじめに
本仕様書は、LGX-Shieldシステムにおけるセンサ計測タスク（TIMU）のソフトウェア仕様を示すものである。  
TIMUは加速度センサを用いた周期サンプリング処理を担い、AI推論や通信タスクへ入力データを供給する役割を持つ。

---

## 機能概要
TIMUは以下の機能を提供する。

1. **周期サンプリング処理**  
   内蔵GPTタイマを用いて100Hz周期でセンサを駆動し、加速度データを収集する。

2. **センサデータ収集**  
   TDK InvenSense MPU-9250からI²C通信により加速度、ジャイロ、温度を取得する。  
   実際に利用するのは加速度Z軸データである。

3. **データ蓄積と通知**  
   1024サンプル分のZ軸加速度データをバッファに蓄積後、アプリケーションタスク（TAPP）へ通知する。

4. **構成要素の初期化**  
   GPTタイマおよびI²Cデバイスドライバを初期化し、センサ設定を確認する。

---

## 機能詳細

### 1. タスク初期化
- **関数名**: `init_task_timu`  
- **処理内容**:  
  - GPTタイマの初期化 (`init_gpt`)  
  - I²Cデバイスのオープン  
  - センサ設定の確認 (`check_accel_config`)  

---

### 2. GPTタイマ初期化
- **関数名**: `init_gpt`  
- **処理内容**:  
  - GPT割り込みハンドラを登録 (`gpt_handler`)  
  - GPTチャネルをオープンし、10ms周期（100Hz）で動作開始  

---

### 3. タスクメイン
- **関数名**: `task_timu`  
- **処理内容**:  
  1. タスク起動時に初期化処理を実行  
  2. 無限ループ内で以下を実施  
     - 周期タイマ割り込みによるタスクウェイクアップを待機  
     - MPU-9250から加速度・ジャイロ・温度を取得 (`read_mpu9250`)  
     - Z軸加速度をバッファ `mir.accz[]` に蓄積  
     - 1024サンプル収集後、`send_imu_ind` によりTAPPへ通知  

---

### 4. 割り込みハンドラ
- **関数名**: `gpt_handler`  
- **処理内容**:  
  - GPTの周期終端割り込みを処理し、割り込みフラグをクリア  
  - TIMUタスクをウェイクアップさせ、データ収集を実行させる  

---

### 5. センサデータ取得
- **関数名**: `read2` / `read_mpu9250`  
- **処理内容**:  
  - `read2`: MPU-9250の指定レジスタから2バイトを読み込み  
  - `read_mpu9250`: 加速度（XYZ）、ジャイロ（XYZ）、温度をまとめて取得し構造体へ格納  

---

### 6. センサ設定確認
- **関数名**: `check_accel_config`  
- **処理内容**:  
  - MPU-9250のACCEL_CONFIGレジスタを読み取り、加速度フルスケール設定を確認  
  - UART出力で設定内容を表示（±2G、±4G、±8G、±16G）  

---

### 7. データ通知
- **関数名**: `send_imu_ind`  
- **処理内容**:  
  - 固定長メモリプールからメッセージ領域を確保  
  - `MSGID_TIMU_IND` メッセージを作成し、TAPPへ送信  
  - 加速度データ（Z軸1024サンプル）と計測時刻を含める  

---

## その他
1. **リアルタイム性**  
   100Hz周期での安定したデータ収集を保証し、上位処理（FFT、AI推論）が適切な入力データを得られるよう設計されている。  

2. **拡張性**  
   現状はZ軸加速度を使用しているが、X/Y軸やジャイロ値の利用にも対応可能な構造である。  

3. **役割**  
   TIMUはシステムにおける「入力インタフェース」として、物理現象（振動）をデジタルデータに変換し、解析処理へ橋渡しする重要なタスクである。  
