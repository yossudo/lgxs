# Ethernetデバイスドライバ仕様書

## はじめに
本仕様書は、LGX-Shieldシステムにおいて新規実装されたEthernetデバイスドライバの仕様を示すものである。  
本ドライバはRenesas RA8D1搭載EthernetコントローラをT-Kernelデバイスドライバとして利用可能にし、UDP送信などの通信機能を実現するための基盤を提供する。

---

## 機能概要
Ethernetデバイスドライバは以下の機能を提供する。

1. **デバイスオープン処理**  
   PHYリセット制御後にEthernetコントローラを初期化し、リンクアップを待機する。

2. **送信処理**  
   T-KernelデバイスI/Fを介して指定データをEthernet経由で送信する。  
   送信完了はイベントフラグで通知される。

3. **受信処理**  
   Ethernetコントローラからのデータ受信をT-KernelデバイスI/Fを通じて提供する。  
   受信完了もイベントフラグで通知される。

4. **T-Kernelデバイスドライバ登録**  
   mSDIインタフェースに基づき、`/dev/hetha` 形式のデバイス名で登録される。

---

## 機能詳細

### 1. 制御ブロック
- **構造体名**: `T_HAL_ETH_DCB`  
- **内容**:  
  - `heth` : Etherハンドル  
  - `ceth` : Ether設定  
  - `devid` : デバイスID  
  - `omode` : オープンモード  
  - `unit` : ユニット番号  
  - `evtmbfid` : イベント通知用メールボックスID  

---

### 2. デバイスオープン
- **関数名**: `dev_eth_openfn`  
- **処理内容**:  
  1. PHYリセット信号を制御（IOポート経由）。  
  2. Ethernetコントローラを初期化。  
  3. `R_ETHER_Open` を実行し、リンクアップ完了まで `R_ETHER_LinkProcess` を繰り返す。  
  4. 成功時に `E_OK` を返却。  

---

### 3. データ送受信処理

#### 送信
- **関数名**: `dev_eth_writefn` → `write_data`  
- **処理内容**:  
  - `R_ETHER_Write` により送信データをDMA経由でEthernetへ出力。  
  - イベントフラグ待ち (`tk_wai_flg`) により送信完了を確認。  
  - 正常完了時に実際の送信サイズを返却。  

#### 受信
- **関数名**: `dev_eth_readfn` → `read_data`  
- **処理内容**:  
  - `R_ETHER_Read` により受信データを取得。  
  - イベントフラグ待ちにより受信完了を確認。  
  - 正常完了時に受信サイズを返却。  

---

### 4. デバイス初期化と登録
- **関数名**: `dev_init_hal_eth`  
- **処理内容**:  
  - 制御ブロック領域を確保。  
  - イベントフラグを生成。  
  - mSDIインタフェースに基づきデバイス情報を設定し、`msdi_def_dev` で登録。  
  - デバイス名は `"hetha"`, `"hethb"` の形式で付与される。  

---

## その他

1. **リアルタイム性**  
   イベントフラグを用いた同期により、送受信処理のリアルタイム性を担保している。  

2. **拡張性**  
   現在は単一ユニットを対象とした設計だが、複数ユニット登録に対応可能な構造を持つ。  

3. **役割**  
   本ドライバは、ユーザタスク（TNETなど）から透過的にEthernet通信を利用可能とする基盤であり、システムの外部接続性を確立する重要な要素である。  
