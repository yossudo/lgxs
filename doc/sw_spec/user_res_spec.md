# ユーザ定義T-Kernelオブジェクト仕様書

## はじめに
本仕様書は、LGX-Shieldシステムにおけるユーザ定義のT-Kernelオブジェクト（タスクID、メールボックスID、メモリプールID、メッセージ構造体等）の仕様を示すものである。  
本定義はタスク間通信、データ共有、システム資源管理の基盤を形成する。

---

## 機能概要
本モジュールは以下の機能を提供する。

1. **タスク管理**  
   ユーザレベルで使用する各タスクのID、優先度、スタックサイズを定義する。

2. **タスク間通信**  
   メールボックスIDを定義し、非同期メッセージ通信を可能にする。

3. **メモリ管理**  
   固定長メモリプールを定義し、大容量データと小容量データの効率的な送受信を可能にする。

4. **メッセージ構造体定義**  
   汎用メッセージヘッダおよびIMUデータ通知、AI推論要求、ネットワーク送信要求等のメッセージ構造を定義する。

---

## 機能詳細

### 1. タスク定義

#### タスクID
- **列挙型**: `task_id_t`  
- **内容**:  
  - `TSKID_USRMAIN` : 初期タスク  
  - `TSKID_TAPP` : アプリケーションメインタスク  
  - `TSKID_TAI` : AI推論タスク  
  - `TSKID_TIMU` : 慣性センサ中間タスク  
  - `TSKID_TNET` : ネットワーク通信タスク  

#### タスク優先度
- **列挙型**: `task_pri_t`  
- **内容**:  
  - `TPRI_TIMU = 5` : 最も高い優先度で動作（100Hzサンプリング保証）  
  - `TPRI_TNET = 8` : ネットワーク通信処理  
  - `TPRI_TAI = 10` : AI推論処理（FFT・NNを含む）  
  - `TPRI_TAPP = 12` : アプリケーション制御  

#### タスクスタックサイズ
- `STKSZ_TAPP = 2048`  
- `STKSZ_TAI  = 4096`  
- `STKSZ_TIMU = 1024`  
- `STKSZ_TNET = 1024`  

---

### 2. メールボックス定義
- **列挙型**: `mbx_id_t`  
- **内容**:  
  - `MBXID_TAPP` : TAPP用メールボックス  
  - `MBXID_TIMU` : TIMU用メールボックス  
  - `MBXID_TAI` : TAI用メールボックス  
  - `MBXID_TNET` : TNET用メールボックス  

---

### 3. メモリプール定義
- **列挙型**: `mpf_id_t`  
- **内容**:  
  - `MPFID_LARGE = 1` : 大容量データ用（2080B, 加速度1024点など）  
  - `MPFID_SMALL = 2` : 小メッセージ用（32B, 結果や通知など）  

- **プール構成**:  
  - `MPFNUM_LARGE = 4` : 同時に4通の大データ送信可能  
  - `MPFSZ_LARGE = (1024 * sizeof(UH)) + 64`  
  - `MPFNUM_SMALL = 16` : 多数の小メッセージに対応  
  - `MPFSZ_SMALL = 32`  

---

### 4. メッセージ種別
- **列挙型**: `msg_id_t`  
- **内容**:  
  - `MSGID_NONE` : 未定義  
  - `MSGID_TIMU_IND` : TIMU→TAPP : IMUデータ通知  
  - `MSGID_TAI_REQ` : TAPP→TAI : AI推論要求  
  - `MSGID_TAI_RES` : TAI→TAPP : AI推論応答  
  - `MSGID_TNET_REQ` : TAPP→TNET : ネットワーク送信要求  
  - `MSGID_TNET_RES` : TNET→TAPP : ネットワーク送信応答  

---

### 5. メッセージ構造体

#### 共通メッセージ
- **構造体名**: `user_msg_t`  
- **内容**:  
  - `msgid` : メッセージID  
  - `srctsk` : 送信元タスクID  
  - `dsttsk` : 送信先タスクID  
  - `result` : 結果コード  
  - `mpfid` : 使用メモリプールID  
  - `pyload` : ペイロード先頭データ  

#### 専用メッセージ
- **IMU通知 (`msg_imu_ind_t`)**  
  - タイムスタンプ  
  - Z軸加速度1024点配列  

- **AI推論要求 (`msg_ai_req_t`)**  
  - タイムスタンプ  
  - Z軸加速度1024点配列  

- **ネットワーク送信要求 (`msg_net_req_t`)**  
  - タイムスタンプ  
  - Z軸加速度1024点配列（拡張用）  

---

## その他
1. **設計方針**  
   - タスク間通信はすべてメールボックスを介して行う。  
   - メッセージデータは固定長メモリプールを使用して管理し、リアルタイム性を確保する。  

2. **役割**  
   本モジュールは、LGX-Shield全体における基盤的リソース定義であり、各タスク間連携を統一的かつ効率的に行うための中心的役割を果たす。  
